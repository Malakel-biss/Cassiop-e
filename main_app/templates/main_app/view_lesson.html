{% extends 'main_app/base.html' %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/custom.css' %}"> <!-- üëà Add this line -->
<link rel="stylesheet" href="{% static 'css/adminlte.min.css' %}">

{% block page_title %}D√©tails de la Le√ßon{% endblock page_title %}

{% block content %}
<div class="container py-4 g-2">
  <h2 class="mb-4">{{ lecon.name }}</h2>
  <p class="text-muted mb-4"><strong>Description :</strong> {{ lecon.description }}</p>

  <!-- üîß Adjusted: tighter spacing and height -->
  <div class="row align-items-stretch g-2 mb-4" style="min-height: 600px;">
    
    <!-- üé• VIDEO COLUMN (~55% width now) -->
    <div class="col-lg-7 d-flex align-items-stretch">
      <div class="w-100 h-100">
        {% if lecon.video %}
          <video controls class="lesson-video-stretch">
            <source src="{{ lecon.video.url }}" type="video/mp4">
          </video>
        {% else %}
          <p class="text-muted">Aucune vid√©o disponible.</p>
        {% endif %}
      </div>
    </div>

    <!-- ü§ñ CHATBOT COLUMN (~45%) -->
    <div class="col-lg-5 d-flex align-items-stretch">
      <div class="card w-100 d-flex flex-column" style="height: 70%;">
        <div class="card-header bg-primary text-white">Assistant IA</div>

        <!-- Scrollable Chat Area -->
        <div id="chat-log" class="flex-grow-1 p-3">
          <!-- Chat messages go here -->
        </div>

        <!-- Input Row -->
        <div class="p-2 border-top bg-white d-flex align-items-center gap-2">
          <input id="chat-input" class="form-control rounded-pill flex-grow-1" placeholder="Envoyer un message..." />
          <button onclick="sendLessonChat()" class="btn btn-primary chat-send-btn rounded-pill">Envoyer</button>
          <button id="record-btn" class="btn btn-danger rounded-pill" 
                  onmousedown="startRecording()" 
                  onmouseup="stopRecording()">Record</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="d-flex justify-content-center flex-wrap my-4" style="gap: 3rem;">
  <!-- üìÑ PDF + Notes Column (~30%) -->
  <div style="flex: 0 0 30%;" class="card shadow-sm">
    <div class="card-header">üìÑ Document PDF</div>
    <div class="card-body">
      {% if lecon.pdf %}
        <a href="{{ lecon.pdf.url }}" target="_blank" class="btn btn-outline-primary mb-2">T√©l√©charger le PDF</a>
      {% else %}
        <p class="text-muted">Aucun document disponible.</p>
      {% endif %}
      <p class="text-muted mb-3">Ce document accompagne la le√ßon pour vous aider √† mieux comprendre.</p>

      <h6 class="mt-4">üìù Notes</h6>
      <textarea class="form-control" rows="5" placeholder="√âcrivez vos notes ici..."></textarea>
    </div>
  </div>

  <!-- üéØ Quiz Column (~50%) -->
  <div style="flex: 0 0 50%;" class="card shadow-sm">
    <div class="card-header bg-warning">üéØ Quiz</div>
    <div class="card-body d-flex flex-column">
      <button class="btn btn-warning w-100 mb-3" onclick="generateQuiz()">G√©n√©rer un Quiz</button>
      <div id="quiz-output" class="text-muted text-center py-4">
        <p class="m-0">üß† Ce quiz vous aidera √† tester votre compr√©hension apr√®s la le√ßon.</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block custom_js %}
<script>
let recorder;
let audioChunks = [];
let quizQuestions = [];
let currentQuestionIndex = 0;
let quizStarted = false;
let score = 0;


function startRecording() {
  console.log("üéôÔ∏è Starting recording...");
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    recorder = new MediaRecorder(stream);
    audioChunks = [];
    recorder.ondataavailable = e => {
      console.log("üì¶ Audio data available:", e.data);
      audioChunks.push(e.data);
    };
    recorder.onstop = sendRecordedVoice;
    recorder.start();
    document.getElementById('record-btn').innerText = "Recording...";
  }).catch(err => {
    console.error("Mic error:", err);
    alert("Microphone inaccessible.");
  });
}

function stopRecording() {
  console.log("üõë Stopping recording...");
  if (recorder && recorder.state === "recording") {
    recorder.stop();
    document.getElementById('record-btn').innerText = "Record";
  }
}



function toggleRecording() {
  if (!recorder || recorder.state === "inactive") {
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = e => audioChunks.push(e.data);
      recorder.onstop = sendRecordedVoice;
      audioChunks = [];
      recorder.start();
      document.getElementById('record-btn').innerText = "‚èπÔ∏è Stop Recording";
    });
  } else {
    recorder.stop();
    document.getElementById('record-btn').innerText = "üé§ Enregistrer";
  }
}
function sendRecordedVoice() {
  const blob = new Blob(audioChunks, { type: 'audio/webm' });
  const formData = new FormData();
  formData.append("audio", blob, "voice.webm");

  const chatLog = document.getElementById("chat-log");

  // Ajout de la bulle utilisateur pour l'audio
  const audioUrl = URL.createObjectURL(blob);
  chatLog.innerHTML += `
    <div class="d-flex justify-content-end mb-2">
      <audio controls class="rounded" style="max-width: 70%;" src="${audioUrl}"></audio>
    </div>
  `;

  // Bulle d'attente du bot
  const botBubbleId = "bot-msg-" + Date.now();
  chatLog.innerHTML += `
    <div class="d-flex justify-content-start mb-2">
      <div id="${botBubbleId}" class="bg-light border rounded p-2 px-3" style="max-width: 70%;">
        <span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
      </div>
    </div>
  `;
  chatLog.scrollTop = chatLog.scrollHeight;

  fetch("{% url 'lesson_chatbot' lecon.id %}", {
    method: "POST",
    headers: { "X-CSRFToken": "{{ csrf_token }}" },
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    const bubble = document.getElementById(botBubbleId);
    const answer = data.answer || "‚ùå Une erreur est survenue.";

    bubble.innerHTML = "";
    let i = 0;
    function typeChar() {
      if (i < answer.length) {
        bubble.innerHTML += answer[i++];
        chatLog.scrollTop = chatLog.scrollHeight;
        setTimeout(typeChar, 18);
      }
    }
    typeChar();

    if (data.audio_url) {
      const audioTag = document.createElement("audio");
      audioTag.src = data.audio_url;
      audioTag.controls = true;
      audioTag.className = "mt-2 w-100 rounded";
      bubble.appendChild(audioTag);
    }
  });
}

function sendLessonChat() {
  const input = document.getElementById("chat-input");
  const question = input.value.trim();
  const chatLog = document.getElementById("chat-log");

  if (!question) return;

  // Add user message bubble
  chatLog.innerHTML += `
    <div class="d-flex justify-content-end mb-2">
      <div class="bg-primary text-white rounded p-2 px-3" style="max-width: 70%;">${question}</div>
    </div>
  `;
  input.value = "";
  chatLog.scrollTop = chatLog.scrollHeight;

  // Start bot bubble with typing dots
  const botBubbleId = "bot-msg-" + Date.now();
  chatLog.innerHTML += `
    <div class="d-flex justify-content-start mb-2">
      <div id="${botBubbleId}" class="bg-light border rounded p-2 px-3" style="max-width: 70%;">
        <span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
      </div>
    </div>
  `;
  chatLog.scrollTop = chatLog.scrollHeight;

  fetch("{% url 'lesson_chatbot' lecon.id %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: new URLSearchParams({ question })
  })
  .then(res => res.json())
  .then(data => {
    const answer = data.answer || "‚ùå Erreur de r√©ponse.";
    const bubble = document.getElementById(botBubbleId);
    bubble.innerHTML = "";
    let i = 0;
    function typeChar() {
      if (i < answer.length) {
        bubble.innerHTML += answer[i++];
        chatLog.scrollTop = chatLog.scrollHeight;
        setTimeout(typeChar, 18); // typing speed
      }
    }
    typeChar();
  });
}

function readChatAloud() {
  const audio = document.getElementById("tts-audio");
  if (audio.src) audio.play();
}

function generateQuiz() {
  score = 0;
  const output = document.getElementById('quiz-output');
  output.innerHTML = `<div class="text-muted">‚è≥ G√©n√©ration du quiz...</div>`;

  fetch("{% url 'generate_quiz' lecon.id %}", {
    method: "POST",
    headers: { "X-CSRFToken": "{{ csrf_token }}" }
  })
  .then(res => res.json())
  .then(data => {
    const nested = data.quiz?.quiz?.questions || data.quiz?.questions || [];
    if (!nested.length) {
      output.innerHTML = `<div class="text-danger">‚ùå Aucune question re√ßue.</div>`;
      return;
    }

    quizQuestions = nested;
    currentQuestionIndex = 0;
    quizStarted = true;
    showCurrentQuestion();
  })
  .catch(err => {
    output.innerHTML = `<div class="text-danger">‚ùå Erreur lors de la g√©n√©ration.</div>`;
    console.error(err);
  });
}

function showCurrentQuestion() {
  const output = document.getElementById('quiz-output');
  const q = quizQuestions[currentQuestionIndex];

  const optionsHtml = q.options.map((opt, i) => `
    <button onclick="submitAnswer('${opt.replace(/'/g, "\\'")}')" class="btn btn-outline-primary w-100 text-start mb-2">${opt}</button>
  `).join("");

  output.innerHTML = `
    <div class="card shadow-sm p-3">
      <h6>Question ${currentQuestionIndex + 1} / ${quizQuestions.length}</h6>
      <p class="fw-bold">${q.question}</p>
      ${optionsHtml}
      <div id="quiz-feedback" class="mt-3"></div>
    </div>
  `;
}

function resetQuiz() {
  quizQuestions = [];
  currentQuestionIndex = 0;
  quizStarted = false;
  score = 0;

  document.getElementById('quiz-output').innerHTML = `
    <div class="text-muted">Cliquez sur <strong>G√©n√©rer un Quiz</strong> pour commencer.</div>
  `;
}

function submitAnswer(selected) {
  const q = quizQuestions[currentQuestionIndex];
  const isCorrect = selected === q.answer;
  const feedback = document.getElementById('quiz-feedback');

  if (isCorrect) score++;

  feedback.innerHTML = `
    <div class="alert ${isCorrect ? 'alert-success' : 'alert-danger'}">
      ${isCorrect ? "‚úÖ Bonne r√©ponse !" : `‚ùå Mauvaise r√©ponse. La bonne √©tait : <strong>${q.answer}</strong>`}
    </div>
    ${currentQuestionIndex + 1 < quizQuestions.length
      ? `<button class="btn btn-secondary mt-2" onclick="nextQuestion()">Question Suivante ‚Üí</button>`
      : `
        <div class="alert alert-success mt-2">
          üéâ Quiz termin√© !<br>
          ‚úÖ Score : <strong>${score} / ${quizQuestions.length}</strong>
        </div>
        <button class="btn btn-primary mt-2" onclick="resetQuiz()">‚Ü©Ô∏è Recommencer le Quiz</button>
      `}
  `;

  // Disable only the answer buttons, not the next button
  document.querySelectorAll("#quiz-output .quiz-option").forEach(btn => {
    btn.disabled = true;
  });
}

function nextQuestion() {
  currentQuestionIndex++;
  if (currentQuestionIndex < quizQuestions.length) {
    showCurrentQuestion();
  }
}


</script>
{% endblock %}
